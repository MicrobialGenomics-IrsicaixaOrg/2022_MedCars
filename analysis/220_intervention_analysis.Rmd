---
site: workflowr::wflow_site
title: "Intervention Analysis"
author: "Marc Noguera-Julian, PhD. "
date: "`r format(Sys.time(), '%Y-%m-%d')`"
header-includes:
- \usepackage{fancyhdr}
- \usepackage{lipsum}
- \pagestyle{fancy}
- \fancyhead[CO,CE]{Microbioma intestinal en intervencion nutricional}
- \fancyfoot[LO,RE]{Marc Noguera-Julian, IrsiCaixa}
- \fancyhead[LE,RO]{\thepage}
- \fancyfoot[CO,CE]{}
- \usepackage[default]{sourcesanspro}
- \usepackage[T1]{fontenc}
- \usepackage{eso-pic,graphicx,transparent}
mainfont: Helvetica
output: html_document
---

```{r setup, include=TRUE, echo=F, message=FALSE, warning=FALSE, paged.print=FALSE, tidy=F}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_knit$set(root.dir = here::here())
rmd_env <- "devel"
```

## Introduction

The main purpose of this analysis is to characterize changes in the microbiome composition related to the nutritional intervention.

## Alpha Diversity

### Chao1 - Paired Comparison

For every Center, we statistically test whether species richness, as assessed by Chao1 estimator is different between M0 and M6, after the nutrititional intervention. For that we use a paired t-test comparison. Chao1 index is an estimator of the number of different taxa that are found in the sample.

Results indicate that in both centers there are slight decreases in Chao1-estimated taxa richness.

```{r alpha diversity chunk 1, echo=F, message=FALSE, warning=FALSE, paged.print=FALSE, tidy=F}
suppressWarnings(require(phyloseq))
suppressWarnings(require(phylosmith))
suppressWarnings(require(patchwork))
suppressWarnings(require(vegan))
suppressWarnings(require(ggstatsplot))
# Load package from local copy
suppressWarnings(devtools::load_all("~/Documents/Work/Development/WMGSPipeline/"))
ps_silva<-readRDS("data/cfu/DADA2/ps_silva.rds")
myMREObject<-readRDS("data/cfu/mreObject.rds")
myMREObject@wd<-"output/mre_data/cfu"

p0<-phyloseq::sample_data(ps_silva) %>% 
  data.frame( ) %>% 
  dplyr::filter(Center=="C01") %>% 
  dplyr::select(SampleID,Timepoint,Center,Participante,chao1,diversity_shannon) %>% 
  dplyr::group_by(Participante) %>% 
  ggstatsplot::ggwithinstats(.,x=Timepoint,
                              y=chao1,
                              type = "parametric", 
                              centrality.plotting=T,bf.message = FALSE,
                              p.adjust.method = "BH",pairwise.display = F, title =  "Chao1 vs Timepoint / C01",
                              annotation.args = list(title = "Shannon index vs Timepoint",
                                                         theme = ggplot2::theme(
                                                                plot.subtitle = ggplot2::element_text(size = 13),
                                                                plot.title = ggplot2::element_text(size = 14)
                                                                )
                                                         ))

p1<-phyloseq::sample_data(ps_silva) %>% 
  data.frame( ) %>% 
  dplyr::filter(Center=="C02") %>% 
  dplyr::select(SampleID,Timepoint,Center,Participante,chao1,diversity_shannon) %>% 
  dplyr::group_by(Participante) %>% 
  ggstatsplot::ggwithinstats(.,x=Timepoint,
                              y=chao1,
                              type = "parametric", 
                              centrality.plotting=T,bf.message = FALSE,
                              p.adjust.method = "BH", pairwise.display = F, title =  "Chao1  vs Timepoint / C02",
                              annotation.args = list(title = "Shannon index vs Timepoint",
                                                         theme = ggplot2::theme(
                                                                plot.subtitle = ggplot2::element_text(size = 13),
                                                                plot.title = ggplot2::element_text(size = 14)
                                                                )
                                                         ))


p0  / p1 + plot_layout(heights = c(25,25),guides="collect",nrow = 2)
```


### Shannon - Paired comparison

For every Center, we statistically test whether alhpa diversity (Shannon Index) is different between M0 and M6, after the nutrititional intervention. For that we use a paired t-test comparison. Shannon Index is an estimator of how many different taxa are found in the sample and how evenely distributed are these taxa within the sample. The higher the index is, the higher the number of taxa and/or their evenness.

Results indicate that in both centers there are slight decreases in the alpha diversity after the intervention.

```{r alpha diversity chunk 2, echo=F, message=FALSE, warning=FALSE, paged.print=FALSE, tidy=F}
suppressWarnings(require(phyloseq))
suppressWarnings(require(phylosmith))
suppressWarnings(require(patchwork))
suppressWarnings(require(vegan))
suppressWarnings(require(ggstatsplot))
# Load package from local copy
suppressWarnings(devtools::load_all("~/Documents/Work/Development/WMGSPipeline/"))
ps_silva<-readRDS("data/cfu/DADA2/ps_silva.rds")
myMREObject<-readRDS("data/cfu/mreObject.rds")
myMREObject@wd<-"output/mre_data/cfu"

p0<-phyloseq::sample_data(ps_silva) %>% 
  data.frame( ) %>% 
  dplyr::filter(Center=="C01") %>% 
  dplyr::select(SampleID,Timepoint,Center,Participante,chao1,diversity_shannon) %>% 
  dplyr::group_by(Participante) %>% 
  ggstatsplot::ggwithinstats(.,x=Timepoint,
                              y=diversity_shannon,
                              type = "parametric", 
                              centrality.plotting=T,bf.message = FALSE,
                              p.adjust.method = "BH",pairwise.display = F, title =  "Shannon index vs Timepoint / C01",
                              annotation.args = list(title = "Shannon index vs Timepoint",
                                                         theme = ggplot2::theme(
                                                                plot.subtitle = ggplot2::element_text(size = 13),
                                                                plot.title = ggplot2::element_text(size = 14)
                                                                )
                                                         ))

p1<-phyloseq::sample_data(ps_silva) %>% 
  data.frame( ) %>% 
  dplyr::filter(Center=="C02") %>% 
  dplyr::select(SampleID,Timepoint,Center,Participante,chao1,diversity_shannon) %>% 
  dplyr::group_by(Participante) %>% 
  ggstatsplot::ggwithinstats(.,x=Timepoint,
                              y=diversity_shannon,
                              type = "parametric", 
                              centrality.plotting=T,bf.message = FALSE,
                              p.adjust.method = "BH", pairwise.display = F, title =  "Shannon index vs Timepoint / C02",
                              annotation.args = list(title = "Shannon index vs Timepoint",
                                                         theme = ggplot2::theme(
                                                                plot.subtitle = ggplot2::element_text(size = 13),
                                                                plot.title = ggplot2::element_text(size = 14)
                                                                )
                                                         ))


p0  / p1 + plot_layout(heights = c(25,25),guides="collect",nrow = 2)
```

### Phylogenetic Distance - Paired Comparison

For every Center, we statistically test whether alhpa diversity (Shannon Index) is different between M0 and M6, after the nutrititional intervention. For that we use a paired t-test comparison. Shannon Index is an estimator of how many different taxa are found in the sample and how evenely distributed are these taxa within the sample. The higher the index is, the higher the number of taxa and/or their evenness.

Results indicate that in both centers there are no significant decreases in phylogenetic distance.

```{r alpha diversity chunk 3, echo=F, message=FALSE, warning=FALSE, paged.print=FALSE, tidy=F}
suppressWarnings(require(phyloseq))
suppressWarnings(require(phylosmith))
suppressWarnings(require(patchwork))
suppressWarnings(require(vegan))
suppressWarnings(require(ggstatsplot))
# Load package from local copy
suppressWarnings(devtools::load_all("~/Documents/Work/Development/WMGSPipeline/"))
ps_silva<-readRDS("data/cfu/DADA2/ps_silva.rds")
myMREObject<-readRDS("data/cfu/mreObject.rds")
myMREObject@wd<-"output/mre_data/cfu"

p0<-phyloseq::sample_data(ps_silva) %>% 
  data.frame( ) %>% 
  dplyr::filter(Center=="C01") %>% 
  dplyr::select(SampleID,Timepoint,Center,Participante,chao1,diversity_shannon,PD) %>% 
  dplyr::group_by(Participante) %>% 
  ggstatsplot::ggwithinstats(.,x=Timepoint,
                              y=PD,
                              type = "parametric", 
                              centrality.plotting=T,bf.message = FALSE,
                              p.adjust.method = "BH",pairwise.display = F, title =  "PD vs Timepoint / C01",
                              annotation.args = list(title = "Shannon index vs Timepoint",
                                                         theme = ggplot2::theme(
                                                                plot.subtitle = ggplot2::element_text(size = 13),
                                                                plot.title = ggplot2::element_text(size = 14)
                                                                )
                                                         ))

p1<-phyloseq::sample_data(ps_silva) %>% 
  data.frame( ) %>% 
  dplyr::filter(Center=="C02") %>% 
  dplyr::select(SampleID,Timepoint,Center,Participante,chao1,diversity_shannon,PD) %>% 
  dplyr::group_by(Participante) %>% 
  ggstatsplot::ggwithinstats(.,x=Timepoint,
                              y=PD,
                              type = "parametric", 
                              centrality.plotting=T,bf.message = FALSE,
                              p.adjust.method = "BH", pairwise.display = F, title =  "PD vs Timepoint / C02",
                              annotation.args = list(title = "Shannon index vs Timepoint",
                                                         theme = ggplot2::theme(
                                                                plot.subtitle = ggplot2::element_text(size = 13),
                                                                plot.title = ggplot2::element_text(size = 14)
                                                                )
                                                         ))


p0  / p1 + plot_layout(heights = c(25,25),guides="collect",nrow = 2)
```

## Beta Diversity

### WUnifrac Comparison

Using paired WUnifrac distances we'll assess the global change for every patient along the 6-month followup. We will calculate distances between M0 and M6 samples for every patient and check where these are difference between Center in order to reveal larger/smaller changes in any of the centers. As a reminder C01 is the center where nutrititional intervention took place.

Results indicate that the change in the gut microbiome after nutritional interventions is slightly but significantly higher in the C01 center.

```{r beta diversity chunk 1, echo=F, message=FALSE, warning=FALSE, paged.print=FALSE, tidy=F}

suppressWarnings(require(phyloseq))
suppressWarnings(require(phylosmith))
suppressWarnings(require(patchwork))
suppressWarnings(require(vegan))
# Load package from local copy
devtools::load_all("~/Documents/Work/Development/WMGSPipeline/")
ps_silva<-readRDS("data/cfu/DADA2/ps_silva.rds")
myMREObject<-readRDS("data/cfu/mreObject.rds")
myMREObject@wd<-"output/mre_data/cfu"

aux_dist<-read.csv("output/Deliverables/WUnifrac_Distances.csv") %>% 
  dplyr::select(-X) %>% 
  dplyr::rename(SampleID=Sample1,SampleID2=Sample2)


pairwise_distances<-sample_data(ps_silva) %>% 
  data.frame() %>% 
  dplyr::filter(Timepoint=="BL") %>% 
  dplyr::left_join(sample_data(ps_silva) %>%
                     data.frame() %>% 
                     dplyr::filter(Timepoint=="Month6") %>% 
                     dplyr::select(SampleID,Participante) %>% 
                     dplyr::rename(SampleID2=SampleID)) %>% 
    dplyr::select(SampleID,SampleID2,Participante,Center)

pairwise_distances %>% 
  dplyr::left_join(.,aux_dist) %>% 
  ggstatsplot::ggbetweenstats(x=Center,y=WUnifracDistance,type="non-parametric",centrality.plotting=T,
                                      annotation.args = list(title = "Beta-diversity vs Center",
                                                         theme = ggplot2::theme(
                                                                plot.subtitle = ggplot2::element_text(size = 11),
                                                                plot.title = ggplot2::element_text(size = 12)
                                                                )
                                                         ))

```

### NMDS Ordination

In order to see differences between cneters in the longitudinal evolution of the gut microbiome of study participants, we'll generate the ordination(NMDS) plots for each separately and evaluate, bots visually and statistically, whether these changes exist and are of similar magnitude. 

According to the NMDS plots for C01(IG) and C02(CG) projecting timepoint as colored ellipse, there is no apparent clustering associated to the intervention, while the ordination dominating genus are very similar.

```{r beta diversity chunk 2, echo=F, message=FALSE, warning=FALSE, paged.print=FALSE, tidy=F}
suppressWarnings(require(phyloseq))
suppressWarnings(require(phylosmith))
suppressWarnings(require(patchwork))
suppressWarnings(require(vegan))
# Load package from local copy
devtools::load_all("~/Documents/Work/Development/WMGSPipeline/")
ps_silva<-readRDS("data/cfu/DADA2/ps_silva.rds")
myMREObject<-readRDS("data/cfu/mreObject.rds")
myMREObject@wd<-"output/mre_data/cfu"

### C01
C01_samples<-myMREObject %>% 
  metar::get_meta() %>% 
  dplyr::filter(Center=="C01")

auxMREObject<-myMREObject %>%
  metar::filter_samples(.,C01_samples$SampleID) 
auxMREObject@metadata@categorical_vals<-auxMREObject@metadata@categorical_vals %>% dplyr::filter(CategoricalVariable!="Center")

# auxMREObject %>% 
#   metar::get_phyloseq(type="dada2") %>% 
#   phyloseq::otu_table() %>% 
#   rowSums() 

auxMREObject<-metar::dada2_nmds(tax_level = "Genus", mre = auxMREObject,top_n = 50, save_files = F)

p0<-auxMREObject@taxa@dada2@nmds$Genus$top_50$categorical$Timepoint+ggtitle("Intervention group")


### C02
C02_samples<-myMREObject %>% 
  metar::get_meta() %>% 
  dplyr::filter(Center=="C02")

auxMREObject<-myMREObject %>%
  metar::filter_samples(.,C02_samples$SampleID) 
auxMREObject@metadata@categorical_vals<-auxMREObject@metadata@categorical_vals %>% dplyr::filter(CategoricalVariable!="Center")

auxMREObject<-metar::dada2_nmds(tax_level = "Genus",mre = auxMREObject,top_n = 50, save_files = F)

p1<-auxMREObject@taxa@dada2@nmds$Genus$top_50$categorical$Timepoint+ggtitle("Control Group")


p0
p1

```

### PERMANOVA 

To Statistically test if there is a significant change in the global structure related to the nutritional intervention in any of the working centers, we use permutational ANOVA(PERMANOVA). This will assess whethere there is an association between timepoint and microbiome composition.

#### Intervention Group

Results indicate there is a statistically significant effect of the intervention on the gut microbiome structure (p=0.001), but its magnitude is very low.(R2=0.007)

```{r beta diversity chunk 3, echo=F, message=FALSE, warning=FALSE, paged.print=FALSE, tidy=F}
suppressWarnings(require(phyloseq))
suppressWarnings(require(phylosmith))
suppressWarnings(require(patchwork))
suppressWarnings(require(vegan))
# Load package from local copy
devtools::load_all("~/Documents/Work/Development/WMGSPipeline/")
ps_silva<-readRDS("data/cfu/DADA2/ps_silva.rds") %>% phyloseq::transform_sample_counts(., function(x) ((x/sum(x))))
myMREObject<-readRDS("data/cfu/mreObject.rds")
myMREObject@wd<-"output/mre_data/cfu"


# #### PERMUTATIONAL ANOVA (adonis()) on WUnifrac distance | C01
ps_silva_c01<-phyloseq::subset_samples(ps_silva,Center=="C01")
sampleData<-sampleData(ps_silva_c01) %>% data.frame()
x.6.0.explanatory<-sampleData[,c("Timepoint","Fumador")]
x.6.0.response<-phyloseq::distance((ps_silva_c01),method="wunifrac")

suppressMessages(require(mmtable2))
suppressMessages(require(tidyr))
vegan::adonis2(x.6.0.response~Timepoint,data=x.6.0.explanatory) %>% broom::tidy() %>% gridExtra::tableGrob() %>% grid::grid.draw()
```

#### Control Group

Results indicate no statistically significant association is found in the control group.

```{r beta diversity chunk 4, echo=F, message=FALSE, warning=FALSE, paged.print=FALSE, tidy=F}
suppressWarnings(require(phyloseq))
suppressWarnings(require(phylosmith))
suppressWarnings(require(patchwork))
suppressWarnings(require(vegan))
# Load package from local copy
devtools::load_all("~/Documents/Work/Development/WMGSPipeline/")
ps_silva<-readRDS("data/cfu/DADA2/ps_silva.rds") %>% phyloseq::transform_sample_counts(., function(x) ((x/sum(x))))
myMREObject<-readRDS("data/cfu/mreObject.rds")
myMREObject@wd<-"output/mre_data/cfu"
# #### PERMUTATIONAL ANOVA (adonis()) on WUnifrac distance | C02
ps_silva_c02<-phyloseq::subset_samples(ps_silva,Center=="C02")
sampleData<-sampleData(ps_silva_c02) %>% data.frame()
x.6.0.explanatory<-sampleData[,c("Timepoint","Fumador")]
x.6.0.response<-phyloseq::distance((ps_silva_c02),method="wunifrac")

suppressMessages(require(mmtable2))
suppressMessages(require(tidyr))
vegan::adonis2(x.6.0.response~Timepoint,data=x.6.0.explanatory) %>% broom::tidy() %>% gridExtra::tableGrob() %>% grid::grid.draw()

```

## Differential Abundance

We have seen that there are no major changes along the nutritional intervention. We can further assess whether there are more subtle differences using differential abundance testing of Month6 vs BL.

### LEFSe

Lefse method uses a combination of non-parametric statistics to reveal those bacterial taxa that are either over- or under-represented in any of the timepoints. Note that we are rarefying to 95th percentile coverage in order to optimized sensitivity. This rarefaction process essentially discards the 5% samples with the lowest throughput,

Results indicate that there several bacterial genera that either over or under abundant in Month6 when compared to BL samples. These changes are specific to C01 only, since there are no significant changes in C02. Differentually abundant bacterial taxa are shown in the plot:

* Bacteroides, Odoribacter and Clostridiales_vadinBB60 group genus are enriched in Baseline sample. Thus, their abundance is reduced after the nutritional intervention.
* Roseburia, Faecalibacterium and Lachnospira are found to have increased abundance after the nutritional intervention. All of these genus, belong to the Firmicutes phylum and are known butyrate producers.

```{r differential abundance chunk 1, echo=F, message=FALSE, warning=FALSE, paged.print=FALSE, tidy=F, fig.cap="LDA Lefse plot, showing enrichment of several general in labelled group"}
suppressWarnings(require(phyloseq))
suppressWarnings(require(phylosmith))
suppressWarnings(require(patchwork))
suppressWarnings(require(vegan))
suppressWarnings(require(lefser))
# Load package from local copy
devtools::load_all("~/Documents/Work/Development/WMGSPipeline/")
ps_silva<-readRDS("data/cfu/DADA2/ps_silva.rds")
myMREObject<-readRDS("data/cfu/mreObject.rds")
myMREObject@wd<-"output/mre_data/cfu"
threshold<-ps_silva %>% otu_table( ) %>% colSums() %>% quantile(.,0.05)
# threshold<-ps_silva %>% otu_table( ) %>% colSums() %>% min()

set.seed(1234)
x.2.0 <-phyloseq::rarefy_even_depth(ps_silva,sample.size = threshold)

### C01
### d samples
x.2.0 <- x.2.0 %>% 
  phyloseq::subset_samples(Center=="C01")
  # microbiome::transform(transform="compositional")

se_ps<-SummarizedExperiment::SummarizedExperiment(assays = list(counts=as.matrix(otu_table(x.2.0))),
                                                  colData=sample_data(x.2.0),
                                                  rowData=tax_table(x.2.0))
aux_res<-lefser(expr=se_ps,groupCol="Timepoint",blockCol = NULL,lda.threshold = 1)
aux_res<- merge(aux_res,tax_table(x.2.0),by.x="Names",by.y="row.names")%>% 
  dplyr::select(Names,Phylum,Class,Order,Family,Genus,scores) %>% 
  dplyr::mutate(Class=ifelse(is.na(Class),Phylum,Class)) %>% 
  dplyr::mutate(Order=ifelse(is.na(Order),Class,Order)) %>% 
  dplyr::mutate(Family=ifelse(is.na(Family),Order,Family)) %>% 
  dplyr::mutate(Genus=ifelse(is.na(Genus),paste0(Family,"_spp"),Genus)) %>% 
  dplyr::filter(! is.na(Genus)) %>% 
  dplyr::mutate(otu=Names) %>% 
  dplyr::mutate(Names=Genus) %>% 
  dplyr::select(otu,Names,scores) %>% 
  dplyr::mutate(Names = forcats::fct_reorder(Names, scores)) %>% 
  dplyr::mutate(time_point=ifelse(scores>0,"Month6","BL"))
p0<-aux_res %>% 
    ggplot(.,aes(x=Names,y=scores,fill=time_point))+geom_bar(stat="identity")+coord_flip()+
    theme_classic()+ggtitle("Month6 vs BL | C01")+
    scale_fill_brewer(palette="Dark2") 
    ggsave(plot=p0,"output/Deliverables/lefser_Month6_vs_BL_C01_samples.pdf")
    
for(otu_name in aux_res$otu){
  my_ps <- x.2.0
  title <- aux_res %>% 
    dplyr::filter(otu==otu_name) 
  my_ps %>% 
  phyloseq::psmelt()%>% 
  dplyr::filter(OTU==otu_name) %>% 
  ggstatsplot::ggbetweenstats(data = .,x=Timepoint,y=Abundance,
                                       xlab=NULL,ylab=NULL,centrality.plotting=T,
                                       bf.message=F,title=title$Names,
                                       method="non-parametric",palette="Dark2") %>% 
  
   ggsave(.,filename=paste0("output/Deliverables/boxplots/",title$Names,"_vs_Timepoint_C01_Samples.pdf"),width=7, height=7)
}

    
### C02
### d samples
set.seed(1234)
x.2.0 <-phyloseq::rarefy_even_depth(ps_silva,sample.size = threshold)
x.2.0 <- x.2.0 %>% 
  phyloseq::subset_samples(Center=="C02")
  # microbiome::transform(transform="compositional")

se_ps<-SummarizedExperiment::SummarizedExperiment(assays = list(counts=as.matrix(otu_table(x.2.0))),
                                                  colData=sample_data(x.2.0),
                                                  rowData=tax_table(x.2.0))
aux_res<-lefser(expr=se_ps,groupCol="Timepoint",blockCol = NULL,lda.threshold = 1)

if(nrow(aux_res)>0){
  aux_res<- merge(aux_res,tax_table(x.2.0),by.x="Names",by.y="row.names")%>% 
  dplyr::select(Names,Phylum,Class,Order,Family,Genus,scores) %>% 
  dplyr::mutate(Class=ifelse(is.na(Class),Phylum,Class)) %>% 
  dplyr::mutate(Order=ifelse(is.na(Order),Class,Order)) %>% 
  dplyr::mutate(Family=ifelse(is.na(Family),Order,Family)) %>% 
  dplyr::mutate(Genus=ifelse(is.na(Genus),paste0(Family,"_spp"),Genus)) %>% 
  dplyr::filter(! is.na(Genus)) %>% 
  dplyr::mutate(otu=Names) %>% 
  dplyr::mutate(Names=Genus) %>% 
  dplyr::select(otu,Names,scores) %>% 
  dplyr::mutate(Names = forcats::fct_reorder(Names, scores)) %>% 
  dplyr::mutate(time_point=ifelse(scores>0,"Month6","BL"))
  p1<-aux_res %>% 
    ggplot(.,aes(x=Names,y=scores,fill=time_point))+geom_bar(stat="identity")+coord_flip()+
    theme_classic()+ggtitle("Month6 vs BL | C02")+
    scale_fill_brewer(palette="Dark2") 
  ggsave(plot=p0,"output/Deliverables/lefser_Month6_vs_BL_C02_samples.pdf")
  
  for(otu_name in aux_res$otu){
    my_ps <- x.2.0
    title <- aux_res %>% 
      dplyr::filter(otu==otu_name) 
    my_ps %>% 
      phyloseq::psmelt()%>% 
      dplyr::filter(OTU==otu_name) %>% 
      ggstatsplot::ggbetweenstats(data = .,x=Timepoint,y=Abundance,
                                  xlab=NULL,ylab=NULL,centrality.plotting=T,
                                  bf.message=F,title=title$Names,
                                  method="non-parametric",palette="Dark2") %>% 
      
      ggsave(.,filename=paste0("output/Deliverables/boxplots/",title$Names,"_vs_Timepoint_C02_Samples.pdf"),width=7, height=7)
  }
}

p0
```





