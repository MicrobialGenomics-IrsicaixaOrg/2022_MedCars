---
site: workflowr::wflow_site
title: "Análisis longitudinal y Dieta "
author: "Marc Noguera-Julian, PhD. TreeTopUnder"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
header-includes:
- \usepackage{fancyhdr}
- \usepackage{lipsum}
- \pagestyle{fancy}
- \fancyhead[CO,CE]{Microbioma y fauna salvaje}
- \fancyfoot[LO,RE]{Marc Noguera-Julian, TreeTopUnder}
- \fancyhead[LE,RO]{\thepage}
- \fancyfoot[CO,CE]{}
- \usepackage[default]{sourcesanspro}
- \usepackage[T1]{fontenc}
- \usepackage{eso-pic,graphicx,transparent}
mainfont: Helvetica
output: html_document
---

```{r setup, include=TRUE,echo=F, message=FALSE, warning=FALSE, paged.print=FALSE, tidy=F}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_knit$set(root.dir = here::here())
```

Como objetivo principal del estudio procedemos a analizar el factor longitudinal de las muestras fecales obtenidas. Cada muestra esta ligada un identificador del animal del que se ha obtenido (dog_name) lo cual nos permite diseño estadísticos apareados. En el conjunto de muestras encontramos muestras apareadas del mismo animal a diferentes tiempos (time_point: t0 o t1), antes y después de la intervención nutricional. Esta intervención consta en un cambio de dieta al suministrar diferentes tipos de pienso que, según la variable *treatment* son:

-   treatment=d, pienso seco.
-   treatment=w1, pienso seco + pienso húmedo
-   treatment=w2, pienso seco + (2x)pienso húmedo

La variable *treatment* esta agrupada en una variable anidada, *dry_wet* que toma el valor dry en el caso de perros con *treatment=d* y el valor "wet" en el caso de perros con *treatment=w1* o *treatment=w2*. De la misma forma partimos de la variable *neutered* (castración) que por el análisis anterior parecen no tener un efecto significativo en la composición del microbioma previa al cambio nutricional.

## Alfa-Diversidad

La alfa diversidad de cada una de las muestras ha sido calculada previamente, en base a los datos disponibles de secuencia. Nos preguntamos:

-   Hay cambios longitudinales en la alfa-diversidad en cada uno de los grupos de tratamiento ( *treatment* )?
-   Hay cambios longitudinales en la alfa-diversidad en cada uno de los grupos de tratamiento ( *dry_wet*)?

*Deliverables: AlphaDiversity.pdf*

Realizando los análisis en cada uno de los subgrupos:

-   No se detectan cambios significativos en los valores de alfa-diversidad (Chao1, Shannon, PD) entre t1 y t0 en el grupo de dieta seca ("d)"
-   Se detecta un a reducción significativa en los valores de diversidad filogenética (PD) entre t1 y t0 en el grupo de dieta húmeda "w1".
-   Se detectan un aumento en la alfa-diversidad (Shannon) y una reducción en la diversidad filogenética (PD) entre t1 y t0 en el grupo de dieta húmeda "w2".

```{r alfa-diversity vs treatment, include=TRUE,echo=F, message=FALSE, warning=FALSE, paged.print=FALSE, tidy=F,fig.height = 15}
suppressMessages(require(phyloseq))
suppressMessages(require(patchwork))
suppressMessages(require(dplyr))

plot_data <- readRDS("data/ps_silva.rds") %>% 
  phyloseq::sample_data() %>% 
  data.frame() %>% 
  dplyr::select(SampleID, treatment, dry_wet, neutered, dog_name,time_point,chao1,diversity_shannon,PD) %>% 
  dplyr::rename(Chao1=chao1,Shannon=diversity_shannon,PhyloDist=PD) %>% 
  reshape2::melt() 

one_sample_dog<-plot_data %>% 
  dplyr::filter(variable=="Chao1") %>% 
  dplyr::group_by(dog_name) %>% 
  dplyr::summarise(n=n()) %>% 
  dplyr::filter(n==1) %>% 
  dplyr::select(dog_name)
### dog_name  "Charlotte" has only one sample and is not suitable for paired analysis


p0<-
  plot_data %>% 
  dplyr::filter(treatment=="d") %>% 
  dplyr::filter(dog_name != one_sample_dog$dog_name) %>% 
  dplyr::group_by(dog_name) %>% 
  ggstatsplot::grouped_ggwithinstats(x=time_point,y=value,grouping.var = variable,type="non-parametric",centrality.plotting=F,
                                      annotation.args = list(title = "treatment: dry (d) diet animals",
                                                         theme = ggplot2::theme(
                                                                plot.subtitle = ggplot2::element_text(size = 13),
                                                                plot.title = ggplot2::element_text(size = 14)
                                                                )
                                                         ),
                                  plotgrid.args = list(nrow = 3))


p1<-plot_data %>% 
  dplyr::filter(treatment=="w1") %>%
  dplyr::filter(dog_name != one_sample_dog$dog_name) %>% 
  dplyr::group_by(dog_name) %>% 
  ggstatsplot::grouped_ggwithinstats(x=time_point,y=value,grouping.var = variable,type="non-parametric",centrality.plotting=F,
                                      annotation.args = list(title = "treatment: wet1 (w1) diet animals",
                                                         theme = ggplot2::theme(
                                                                plot.subtitle = ggplot2::element_text(size = 13),
                                                                plot.title = ggplot2::element_text(size = 14)
                                                                )
                                                         ),
                                  plotgrid.args = list(nrow = 3))


p2<-plot_data %>% 
  dplyr::filter(treatment=="w2") %>% 
  dplyr::filter(dog_name != one_sample_dog$dog_name) %>% 
  dplyr::group_by(dog_name) %>% 
  ggstatsplot::grouped_ggwithinstats(x=time_point,y=value,grouping.var = variable,type="non-parametric",centrality.plotting=F,
                                  annotation.args = list(title = "treatment: wet2 (w2) diet animals",
                                                         theme = ggplot2::theme(
                                                                plot.subtitle = ggplot2::element_text(size = 13),
                                                                plot.title = ggplot2::element_text(size = 14)
                                                                )
                                                         ),
                                  plotgrid.args = list(nrow = 3))

p2
pT<- p0 / p1 / p2
ggplot2::ggsave(p0,filename="output/Deliverables/AlphaDiversity_treatment_dry_only.pdf",height=15,width=7)
ggplot2::ggsave(p1,filename="output/Deliverables/AlphaDiversity_treatment_w1_only.pdf",height=15,width=7)
ggplot2::ggsave(p2,filename="output/Deliverables/AlphaDiversity_treatment_w2_only.pdf",height=15,width=7)
ggplot2::ggsave(pT,filename="output/Deliverables/AlphaDiversity_treatment.pdf",height=15,width=7)


p3<-
  plot_data %>% 
  dplyr::filter(dry_wet=="d") %>% 
  dplyr::filter(dog_name != one_sample_dog$dog_name) %>% 
  dplyr::group_by(dog_name) %>% 
  ggstatsplot::grouped_ggwithinstats(x=time_point,y=value,grouping.var = variable,type="non-parametric",centrality.plotting=F,
                                      annotation.args = list(title = "dry_wet: dry (d) diet animals",
                                                         theme = ggplot2::theme(
                                                                plot.subtitle = ggplot2::element_text(size = 13),
                                                                plot.title = ggplot2::element_text(size = 14)
                                                                )
                                                         ),
                                  plotgrid.args = list(nrow = 3))


p4<-plot_data %>% 
  dplyr::filter(dry_wet=="w") %>%
  dplyr::filter(dog_name != one_sample_dog$dog_name) %>% 
  dplyr::group_by(dog_name) %>% 
  ggstatsplot::grouped_ggwithinstats(x=time_point,y=value,grouping.var = variable,type="non-parametric",centrality.plotting=F,
                                      annotation.args = list(title = "dry_wet: wet (w) diet animals",
                                                         theme = ggplot2::theme(
                                                                plot.subtitle = ggplot2::element_text(size = 13),
                                                                plot.title = ggplot2::element_text(size = 14)
                                                                )
                                                         ),
                                  plotgrid.args = list(nrow = 3))
pT <- p3 / p4
ggplot2::ggsave(p4,filename="output/Deliverables/AlphaDiversity_dry_wet_w_only.pdf",height=10,width=7)
ggplot2::ggsave(pT,filename="output/Deliverables/AlphaDiversity_dry_wet.pdf",height=10,width=7)

```

## Beta-Diversidad

### Evolución longitudinal

Usando el mismo método de análisis que en la sección previa, usamos la similitud entre la composición del microbioma fecal para calcular los indices de beta-diversidad (WUnifrac, Bray, Unifrac) entre muestras de un mismo perro (paired beta-diversity). Cada perro esta asociado a un grupo de tratamiento o variable de interés, por lo que podemos ver si estos valores de paired beta-diversity son diferentes en un grupo u otro.

*Deliverables: BetaDiversityEvolution_per_group.pdf*

No se observan cambios en beta-diversidad diferenciales entre grupos de tratamiento (dry_wet, treatment) usando los indices WUnifrac y Bray. Si se observan usando el indice Unifrac (Unweighted). El indice Unifrac(Unweighted) tiene en consideración la similitud filogenética de las taxas que componen le microbioma pero no su abundancia relativa, lo que si utilizan WUnifrac y Bray.

En el caso de la variable *neutered* (castración) no se observan cambios usando ningún indice de beta-diversidad.

```{r Paired Beta Diversity per variable, include=TRUE,echo=F, message=FALSE, warning=FALSE, paged.print=FALSE, tidy=F,fig.height = 15}

suppressWarnings(require(phyloseq))
suppressWarnings(require(dplyr))
suppressWarnings(require(ggplot2))
suppressWarnings(require(ggforce))
suppressWarnings(require(patchwork))
set.seed(1234)
x.2.0<-readRDS("data/ps_silva.rds")
# x.2.0.genus<-phyloseq::tax_glom(x.2.0,taxrank="Genus",NArm = F)
x.2.0.genus<-x.2.0 %>% 
  phyloseq::rarefy_even_depth() %>% 
  phyloseq::tax_glom(.,taxrank="Genus",NArm = F)
# x.2.0.genus<-transform_sample_counts(x.2.0.genus, function(x) ((x/sum(x))))

### Extract paired WUnifrac distances
aux_dist<-phyloseq::distance(x.2.0.genus,method = "wunifrac") %>% 
  as.matrix() %>% 
  reshape::melt() %>% 
  dplyr::rename(SampleID=X1,SampleID2=X2,wunifrac=value) %>% 
  left_join(phyloseq::distance(x.2.0.genus,method = "bray") %>% 
              as.matrix() %>% 
              reshape::melt() %>% 
              dplyr::rename(SampleID=X1,SampleID2=X2,bray=value)) %>% 
  left_join(phyloseq::distance(x.2.0.genus,method = "unifrac") %>% 
              as.matrix() %>% 
              reshape::melt() %>% 
              dplyr::rename(SampleID=X1,SampleID2=X2,unifrac=value))

pairwise_distances<-sample_data(x.2.0.genus) %>% 
  data.frame() %>% 
  dplyr::filter(time_point=="t0") %>% 
  dplyr::filter(dog_name!="Charlotte") %>% 
  dplyr::left_join(sample_data(x.2.0.genus) %>%
                     data.frame() %>% 
  dplyr::filter(time_point=="t1") %>% 
  dplyr::filter(dog_name!="Charlotte") %>% 
    dplyr::select(SampleID,dog_name) %>% 
    dplyr::rename(SampleID2=SampleID)) %>% 
  dplyr::select(SampleID,SampleID2,dog_name,neutered,dry_wet,treatment)

p0<-pairwise_distances %>% 
  left_join(.,aux_dist) %>% 
  reshape2::melt() %>% 
  ggstatsplot::grouped_ggbetweenstats(x=treatment,y=value,grouping.var = "variable",type="non-parametric",centrality.plotting=F,
                                      annotation.args = list(title = "Beta-diversity vs treatment",
                                                         theme = ggplot2::theme(
                                                                plot.subtitle = ggplot2::element_text(size = 11),
                                                                plot.title = ggplot2::element_text(size = 12)
                                                                )
                                                         ),
                                  plotgrid.args = list(nrow = 3))

p1<-pairwise_distances %>% 
  left_join(.,aux_dist) %>% 
  reshape2::melt() %>% 
  ggstatsplot::grouped_ggbetweenstats(x=dry_wet,y=value,grouping.var = "variable",type="non-parametric",centrality.plotting=F,
                                      annotation.args = list(title = "Beta-diversity vs dry_wet",
                                                         theme = ggplot2::theme(
                                                                plot.subtitle = ggplot2::element_text(size = 11),
                                                                plot.title = ggplot2::element_text(size = 12)
                                                                )
                                                         ),
                                  plotgrid.args = list(nrow = 3))
p2<-pairwise_distances %>% 
  left_join(.,aux_dist) %>% 
  reshape2::melt() %>% 
  ggstatsplot::grouped_ggbetweenstats(x=neutered,y=value,grouping.var = "variable",type="non-parametric",centrality.plotting=F,
                                      annotation.args = list(title = "Beta-diversity vs neutered",
                                                         theme = ggplot2::theme(
                                                                plot.subtitle = ggplot2::element_text(size = 11),
                                                                plot.title = ggplot2::element_text(size = 12)
                                                                )
                                                         ),
                                  plotgrid.args = list(nrow = 3))

p0

pT<-p0 / p1 / p2

# ggsave(plot=pT,filename="output/Deliverables/Beta-Diversity/BetaDiversityEvolution_per_group.pdf",height=30,width=7)
ggsave(plot=p0,filename="output/Deliverables/Beta-Diversity/BetaDiversityEvolution_per_treatment.pdf",height=12,width=7)
ggsave(plot=p1,filename="output/Deliverables/Beta-Diversity/BetaDiversityEvolution_per_dry_wet.pdf",height=12,width=7)
ggsave(plot=p2,filename="output/Deliverables/Beta-Diversity/BetaDiversityEvolution_per_neutered.pdf",height=12,width=7)
```

### Dieta y cambios longitudinales

*Deliverables: Adonis_Longitudinal.xls*

Para testear estadísticamente la influencia del tratamiento/Dieta en los cambios longitudinales de la estructura composicional del microbioma fecal usamos el test de ANOVA permutacional (vegan::adonis) contra la variable time_point en cada uno de los subgrupos definidos por *treatment* o *dry_wet*

Tendremos, pues, el resultado para cada uno de los grupos, que nos revelaran cambios asociados al punto temporal, específicos para cada grupo de dieta.

*Deliverables: Adonis_vs_time_point_per_treatment.xls y Adonis_vs_time_point_per_dry_web.xls*

Se observa relación del tipo de dieta con los cambios estructurales en la composición del microbioma a lo largo de la intervención.

-   En los grupos segregados por *treatment* la variable time_point (antes y después de la intervención) explica un 34% de la composición del microbioma en el grupo con dieta w2, aunque no es significativo en los grupos *d* y *w1*.
-   En la misma tendencia, en los grupos segregados por *dry_web* la variable *time_point*(antes y después de la intervención) explica un 18% de la composición del microbioma en el grupo *w*, aunque no es significativa en el grupo *d*.

Estos resultados indican que hay un cambio global en la estructura composicional del microbioma de los perros asociado a la dieta, especificamente, a la dieta *w2*.

```{r permanova per treatment, include=TRUE,echo=F, message=FALSE, warning=FALSE, paged.print=FALSE, tidy=F, eval=F}
suppressWarnings(require(phyloseq))
suppressWarnings(require(phylosmith))
suppressWarnings(require(patchwork))
suppressWarnings(require(vegan))

set.seed(1234)
x.2.0<-readRDS("data/ps_silva.rds")
# x.2.0.genus<-phyloseq::tax_glom(x.2.0,taxrank="Genus",NArm = F)
x.2.0.genus<-x.2.0 %>% 
  phyloseq::rarefy_even_depth() %>% 
  phyloseq::tax_glom(.,taxrank="Genus",NArm = F)

### treatment == "d"
x.3.0.genus<-x.2.0.genus %>% 
  phyloseq::subset_samples(treatment=="d")
sampleData<-data.frame(sample_data(x.3.0.genus))
rownames(sampleData)<-sampleData$SampleID
sample_data(x.3.0.genus)<-sampleData
# (myOrd<-ordinate(x.3.0.genus,method="NMDS",distance="wunifrac"))
#### PERMUTATIONAL ANOVA (adonis()) on WUnifrac distance (d Samples)
x.6.0.explanatory<-sampleData[,c("time_point","dog_name")]
x.6.0.response<-phyloseq::distance((x.3.0.genus),method="wunifrac")
myAdonis<-vegan::adonis2(x.6.0.response~time_point,data=x.6.0.explanatory)
file.remove("output/Deliverables/Adonis_vs_time_point_per_treatment.xls")
xlsx::write.xlsx(file = "output/Deliverables/Adonis_vs_time_point_per_treatment.xls",sheetName = "d samples",vegan::adonis2(x.6.0.response~time_point,data=x.6.0.explanatory))

### treatment == "w1"
x.3.0.genus<-x.2.0.genus %>% 
  phyloseq::subset_samples(treatment=="w1")
sampleData<-data.frame(sample_data(x.3.0.genus))
rownames(sampleData)<-sampleData$SampleID
sample_data(x.3.0.genus)<-sampleData
# (myOrd<-ordinate(x.3.0.genus,method="NMDS",distance="wunifrac"))
#### PERMUTATIONAL ANOVA (adonis()) on WUnifrac distance (d Samples)
x.6.0.explanatory<-sampleData[,c("time_point","dog_name")]
x.6.0.response<-phyloseq::distance((x.3.0.genus),method="wunifrac")
myAdonis<-vegan::adonis2(x.6.0.response~time_point,data=x.6.0.explanatory)
xlsx::write.xlsx(file = "output/Deliverables/Adonis_vs_time_point_per_treatment.xls",sheetName = "w1 samples",vegan::adonis2(x.6.0.response~time_point,data=x.6.0.explanatory),append = T)

### treatment == "w2"
x.3.0.genus<-x.2.0.genus %>% 
  phyloseq::subset_samples(treatment=="w2")
sampleData<-data.frame(sample_data(x.3.0.genus))
rownames(sampleData)<-sampleData$SampleID
sample_data(x.3.0.genus)<-sampleData
# (myOrd<-ordinate(x.3.0.genus,method="NMDS",distance="wunifrac"))
#### PERMUTATIONAL ANOVA (adonis()) on WUnifrac distance (d Samples)
x.6.0.explanatory<-sampleData[,c("time_point","dog_name")]
x.6.0.response<-phyloseq::distance((x.3.0.genus),method="wunifrac")
myAdonis<-vegan::adonis2(x.6.0.response~time_point,data=x.6.0.explanatory)
xlsx::write.xlsx(file = "output/Deliverables/Adonis_vs_time_point_per_treatment.xls",sheetName = "w2 samples",vegan::adonis2(x.6.0.response~time_point,data=x.6.0.explanatory),append = T)

### dry_wet == "d"
x.3.0.genus<-x.2.0.genus %>% 
  phyloseq::subset_samples(dry_wet=="d")
sampleData<-data.frame(sample_data(x.3.0.genus))
rownames(sampleData)<-sampleData$SampleID
sample_data(x.3.0.genus)<-sampleData
# (myOrd<-ordinate(x.3.0.genus,method="NMDS",distance="wunifrac"))
#### PERMUTATIONAL ANOVA (adonis()) on WUnifrac distance (d Samples)
x.6.0.explanatory<-sampleData[,c("time_point","dog_name")]
x.6.0.response<-phyloseq::distance((x.3.0.genus),method="wunifrac")
myAdonis<-vegan::adonis2(x.6.0.response~time_point,data=x.6.0.explanatory)
file.remove("output/Deliverables/Adonis_vs_time_point_per_dry_wet.xls")
xlsx::write.xlsx(file = "output/Deliverables/Adonis_vs_time_point_per_dry_wet.xls",sheetName = "d samples",vegan::adonis2(x.6.0.response~time_point,data=x.6.0.explanatory),append = T)

### dry_wet == "w"
x.3.0.genus<-x.2.0.genus %>% 
  phyloseq::subset_samples(dry_wet=="w")
sampleData<-data.frame(sample_data(x.3.0.genus))
rownames(sampleData)<-sampleData$SampleID
sample_data(x.3.0.genus)<-sampleData
# (myOrd<-ordinate(x.3.0.genus,method="NMDS",distance="wunifrac"))
#### PERMUTATIONAL ANOVA (adonis()) on WUnifrac distance (d Samples)
x.6.0.explanatory<-sampleData[,c("time_point","dog_name")]
x.6.0.response<-phyloseq::distance((x.3.0.genus),method="wunifrac")
myAdonis<-vegan::adonis2(x.6.0.response~time_point,data=x.6.0.explanatory)
xlsx::write.xlsx(file = "output/Deliverables/Adonis_vs_time_point_per_dry_wet.xls",sheetName = "w samples",vegan::adonis2(x.6.0.response~time_point,data=x.6.0.explanatory),append = T)

```

## Abundancia diferencial.

En este análisis se responderá a las preguntas relacionadas con el cambio concretos, a nivel de género bacteriano, de la composición del microbioma en relación a la intervención nutricional

```{r DA vs dry_wet, include=TRUE,echo=F, message=FALSE, warning=FALSE, paged.print=FALSE, tidy=F,eval=F}
suppressMessages(require(dplyr))
suppressMessages(require(phyloseq))
suppressMessages(require(lefser))
suppressMessages(require(ggplot2))
suppressMessages(require(patchwork))
ps_silva<-readRDS("data/ps_silva.rds")
set.seed(1234)
### Genus Level
### We are really interested in two comparisons Dry vs Wet and Dry vs Wet1 + Dry vs Wet2
x.2.0 <-ps_silva %>% 
  phyloseq::subset_samples(dog_name!="Charlotte") %>% 
  phyloseq::tax_glom(.,taxrank = "Genus",NArm = F) %>%
  # phyloseq::filter_taxa(., function (x) sum(x > 0) > 2, TRUE) %>%
  phyloseq::rarefy_even_depth(.)
  # microbiome::transform(transform="compositional")


se_ps<-SummarizedExperiment::SummarizedExperiment(assays = list(counts=as.matrix(otu_table(x.2.0))),
                                                  colData=sample_data(x.2.0),
                                                  rowData=tax_table(x.2.0))
aux_res<-lefser(expr=se_ps,groupCol="dry_wet",blockCol = NULL,lda.threshold = 1)
aux_res<-merge(aux_res,tax_table(x.2.0),by.x="Names",by.y="row.names")%>% 
  dplyr::select(Names,Phylum,Class,Order,Family,Genus,scores) %>% 
  dplyr::mutate(Class=ifelse(is.na(Class),Phylum,Class)) %>% 
  dplyr::mutate(Order=ifelse(is.na(Order),Class,Order)) %>% 
  dplyr::mutate(Family=ifelse(is.na(Family),Order,Family)) %>% 
  dplyr::mutate(Genus=ifelse(is.na(Genus),paste0(Family,"_spp"),Genus)) %>% 
  dplyr::filter(! is.na(Genus)) %>% 
  dplyr::mutate(otu=Names) %>% 
  dplyr::mutate(Names=Genus) %>% 
  dplyr::select(otu,Names,scores) %>% 
  dplyr::mutate(Names = forcats::fct_reorder(Names, scores)) %>% 
  dplyr::mutate(dry_wet=ifelse(scores>0,"dry","wet"))
p0<-aux_res<-
    ggplot(.,aes(x=Names,y=scores,fill=dry_wet))+geom_bar(stat="identity")+coord_flip()+
    theme_classic()+ggtitle("Dry vs Wet")+
    scale_fill_brewer(palette="Dark2")


```

### Variable *treatment*

Comparativa no paramétrica + LDA entre la abundancia de diferentes géneros bacterianos entre puntos temporales t1 vs t0, estratificada por grupos de tratamiento (d/w & d/w1/w2) y la valoración del *effect size* en la diferencia mediante el paquete *lefser*.

*Deliverables: lefser_t1_vs_t0_d\_samples.pdf, lefser_t1_vs_t0_w1_samples.pdf, lefser_t1_vs_t0_w2_samples.pdf y boxplots independientes para cada género positivo al test*

Se observan taxas diferencialmente abundantes entre puntos temporales, especialmente en los grupos de tratamiento w2 y w **lefser**(<http://www.bioconductor.org/packages/release/bioc/html/lefser.html>):

-   Mayor abundancia en perros después de haber seguido dieta húmeda(w2): *Blautia, Dorea, Escherichia Shigella, grupo R.torques i R.gnavus*
-   Menor abundancia en perros después de haber seguido dieta húmeda(w2): *Peptoclostridium, Megamonas, Prevotella, Alloprevotella, Sutterella*

```{r DA vs time_point all treatment groups, include=TRUE,echo=F, message=FALSE, warning=FALSE, paged.print=FALSE, tidy=F}
suppressMessages(require(dplyr))
suppressMessages(require(phyloseq))
suppressMessages(require(lefser))
suppressMessages(require(ggplot2))
suppressMessages(require(patchwork))
ps_silva<-readRDS("data/ps_silva.rds")
set.seed(1234)
### Genus Level
### We are really interested in comparing t1 vs t0, separately for each d,w1,w2 and d/w

x.2.0 <-ps_silva %>% 
  phyloseq::subset_samples(dog_name!="Charlotte") %>% 
  phyloseq::tax_glom(.,taxrank = "Genus",NArm = F) %>%
  # phyloseq::filter_taxa(., function (x) sum(x > 0) > 2, TRUE) %>%
  phyloseq::rarefy_even_depth(.)


### d samples
x.2.0 <- x.2.0 %>% 
  phyloseq::subset_samples(treatment=="d")
  # microbiome::transform(transform="compositional")

se_ps<-SummarizedExperiment::SummarizedExperiment(assays = list(counts=as.matrix(otu_table(x.2.0))),
                                                  colData=sample_data(x.2.0),
                                                  rowData=tax_table(x.2.0))
aux_res<-lefser(expr=se_ps,groupCol="time_point",blockCol = NULL,lda.threshold = 1)
aux_res<- merge(aux_res,tax_table(x.2.0),by.x="Names",by.y="row.names")%>% 
  dplyr::select(Names,Phylum,Class,Order,Family,Genus,scores) %>% 
  dplyr::mutate(Class=ifelse(is.na(Class),Phylum,Class)) %>% 
  dplyr::mutate(Order=ifelse(is.na(Order),Class,Order)) %>% 
  dplyr::mutate(Family=ifelse(is.na(Family),Order,Family)) %>% 
  dplyr::mutate(Genus=ifelse(is.na(Genus),paste0(Family,"_spp"),Genus)) %>% 
  dplyr::filter(! is.na(Genus)) %>% 
  dplyr::mutate(otu=Names) %>% 
  dplyr::mutate(Names=Genus) %>% 
  dplyr::select(otu,Names,scores) %>% 
  dplyr::mutate(Names = forcats::fct_reorder(Names, scores)) %>% 
  dplyr::mutate(time_point=ifelse(scores>0,"t1","t0"))
p0<-aux_res %>% 
    ggplot(.,aes(x=Names,y=scores,fill=time_point))+geom_bar(stat="identity")+coord_flip()+
    theme_classic()+ggtitle("t1 vs t0")+
    scale_fill_brewer(palette="Dark2") 
    ggsave(plot=p0,"output/Deliverables/lefser_t1_vs_t0_d_samples.pdf")
for(otu_name in aux_res$otu){
  my_ps <- x.2.0
  title <- aux_res %>% 
    dplyr::filter(otu==otu_name) 
  my_ps %>% 
  phyloseq::psmelt()%>% 
  dplyr::filter(OTU==otu_name) %>% 
  ggstatsplot::ggwithinstats(data = .,x=time_point,y=Abundance,
                                       xlab=NULL,ylab=NULL,centrality.plotting=F,
                                       bf.message=F,title=title$Names,
                                       method="non-parametric",palette="Dark2") %>% 
  
   ggsave(.,filename=paste0("output/boxplots/",title$Names,"_vs_time_point_d_Samples.pdf"),width=7, height=7)
}


### w1 samples
x.2.0 <-ps_silva %>% 
  phyloseq::subset_samples(dog_name!="Charlotte") %>% 
  phyloseq::tax_glom(.,taxrank = "Genus",NArm = F) %>%
  # phyloseq::filter_taxa(., function (x) sum(x > 0) > 2, TRUE) %>%
  phyloseq::rarefy_even_depth(.) 
x.2.0 <- x.2.0 %>% 
  phyloseq::subset_samples(treatment=="w1")
  # microbiome::transform(transform="compositional")

se_ps<-SummarizedExperiment::SummarizedExperiment(assays = list(counts=as.matrix(otu_table(x.2.0))),
                                                  colData=sample_data(x.2.0),
                                                  rowData=tax_table(x.2.0))
aux_res<-lefser(expr=se_ps,groupCol="time_point",blockCol = NULL,lda.threshold = 1)
aux_res<-merge(aux_res,tax_table(x.2.0),by.x="Names",by.y="row.names")%>% 
  dplyr::select(Names,Phylum,Class,Order,Family,Genus,scores) %>% 
  dplyr::mutate(Class=ifelse(is.na(Class),Phylum,Class)) %>% 
  dplyr::mutate(Order=ifelse(is.na(Order),Class,Order)) %>% 
  dplyr::mutate(Family=ifelse(is.na(Family),Order,Family)) %>% 
  dplyr::mutate(Genus=ifelse(is.na(Genus),paste0(Family,"_spp"),Genus)) %>% 
  dplyr::filter(! is.na(Genus)) %>% 
  dplyr::mutate(otu=Names) %>% 
  dplyr::mutate(Names=Genus) %>% 
  dplyr::select(otu,Names,scores) %>% 
  dplyr::mutate(Names = forcats::fct_reorder(Names, scores)) %>% 
  dplyr::mutate(time_point=ifelse(scores>0,"t1","t0"))
p1<-aux_res%>% 
    ggplot(.,aes(x=Names,y=scores,fill=time_point))+geom_bar(stat="identity")+coord_flip()+
    theme_classic()+ggtitle("t1 vs t0")+
    scale_fill_brewer(palette="Dark2") 
    ggsave(plot=p1,"output/Deliverables/lefser_t1_vs_t0_w1_samples.pdf")

for(otu_name in aux_res$otu){
  my_ps <- x.2.0
  title <- aux_res %>% 
    dplyr::filter(otu==otu_name) 
    
  my_ps %>% 
  phyloseq::psmelt()%>% 
  dplyr::filter(OTU==otu_name) %>% 
  ggstatsplot::ggwithinstats(data = .,x=time_point,y=Abundance,
                                       xlab=NULL,ylab=NULL,centrality.plotting=F,
                                       bf.message=F,title=title$Names,
                                       method="non-parametric",palette="Dark2") %>% 
  
   ggsave(.,filename=paste0("output/boxplots/",title$Names,"_vs_time_point_w1_Samples.pdf"),width=7, height=7)
}

### w2 samples
x.2.0 <-ps_silva %>% 
  phyloseq::subset_samples(dog_name!="Charlotte") %>% 
  phyloseq::tax_glom(.,taxrank = "Genus",NArm = F) %>%
  # phyloseq::filter_taxa(., function (x) sum(x > 0) > 2, TRUE) %>%
  phyloseq::rarefy_even_depth(.) 
x.2.0 <- x.2.0 %>% 
  phyloseq::subset_samples(treatment=="w2")
  # microbiome::transform(transform="compositional")

se_ps<-SummarizedExperiment::SummarizedExperiment(assays = list(counts=as.matrix(otu_table(x.2.0))),
                                                  colData=sample_data(x.2.0),
                                                  rowData=tax_table(x.2.0))
aux_res<-lefser(expr=se_ps,groupCol="time_point",blockCol = NULL,lda.threshold = 1)
aux_res<-merge(aux_res,tax_table(x.2.0),by.x="Names",by.y="row.names")%>% 
  dplyr::select(Names,Phylum,Class,Order,Family,Genus,scores) %>% 
  dplyr::mutate(Class=ifelse(is.na(Class),Phylum,Class)) %>% 
  dplyr::mutate(Order=ifelse(is.na(Order),Class,Order)) %>% 
  dplyr::mutate(Family=ifelse(is.na(Family),Order,Family)) %>% 
  dplyr::mutate(Genus=ifelse(is.na(Genus),paste0(Family,"_spp"),Genus)) %>% 
  dplyr::filter(! is.na(Genus)) %>% 
  dplyr::mutate(otu=Names) %>% 
  dplyr::mutate(Names=Genus) %>% 
  dplyr::select(otu,Names,scores) %>% 
  dplyr::mutate(Names = forcats::fct_reorder(Names, scores)) %>% 
  dplyr::mutate(time_point=ifelse(scores>0,"t1","t0")) 

p2<-aux_res %>% 
    ggplot(.,aes(x=Names,y=scores,fill=time_point))+geom_bar(stat="identity")+coord_flip()+
    theme_classic()+ggtitle("t1 vs t0")+
    scale_fill_brewer(palette="Dark2")
    ggsave(plot=p2,"output/Deliverables/lefser_t1_vs_t0_w2_samples.pdf")
for(otu_name in aux_res$otu){
  
  my_ps <- x.2.0
  title <- aux_res %>% 
    dplyr::filter(otu==otu_name) 
    
  my_ps %>% 
  phyloseq::psmelt()%>% 
  dplyr::filter(OTU==otu_name) %>% 
  ggstatsplot::ggwithinstats(data = .,x=time_point,y=Abundance,
                                       xlab=NULL,ylab=NULL,centrality.plotting=F,
                                       bf.message=F,title=title$Names,
                                       method="non-parametric",palette="Dark2") %>% 
   ggsave(.,filename=paste0("output/boxplots/",title$Names,"_vs_time_point_w2_Samples.pdf"),width=7, height=7)
}

p2 

```

Como ejemplo de géneros diferencialmente abundantes, se muestran las abundancias de dos de los géneros que mas diferencias presentan entre t0 y t1 para el grupo *w2*. En el caso del género *Blautia* se detecta un incremento consistente en el numero de *reads* asignados a ese género bacteriano (p\<0.07, en test apareado) para todos los animales.

```{r include graphics Blautia, eval=T, include=TRUE,echo=F, message=FALSE, warning=FALSE, paged.print=FALSE, tidy=F}
suppressMessages(require(dplyr))
suppressMessages(require(phyloseq))
suppressMessages(require(lefser))
suppressMessages(require(ggplot2))
suppressMessages(require(patchwork))

set.seed(1234)
### Genus Level
### We are really interested in comparing t1 vs t0, separately for each d,w1,w2 and d/w
title<-"Blautia"
readRDS("data/ps_silva.rds")%>% 
  phyloseq::subset_samples(dog_name!="Charlotte") %>% 
  phyloseq::tax_glom(.,taxrank = "Genus",NArm = F) %>%
  # phyloseq::filter_taxa(., function (x) sum(x > 0) > 2, TRUE) %>%
  phyloseq::rarefy_even_depth(.) %>% 
  phyloseq::subset_samples(treatment=="w2") %>% 
  phyloseq::psmelt( ) %>% 
  dplyr::filter(Genus==title) %>% 
  ggstatsplot::ggwithinstats(data = .,x=time_point,y=Abundance,
                                       xlab=NULL,ylab=NULL,centrality.plotting=F,
                                       bf.message=F,title=title,
                                       method="non-parametric",palette="Dark2")

```

En el otro sentido, el género *Faecalibacterium*, reduce su presencia o pasa a ser indetectable en *t1* en el mismo grupo de animales ( *w2* )

```{r include graphics Faecalibacterium, eval=T, include=TRUE,echo=F, message=FALSE, warning=FALSE, paged.print=FALSE, tidy=F}
suppressMessages(require(dplyr))
suppressMessages(require(phyloseq))
suppressMessages(require(lefser))
suppressMessages(require(ggplot2))
suppressMessages(require(patchwork))

set.seed(1234)
### Genus Level
### We are really interested in comparing t1 vs t0, separately for each d,w1,w2 and d/w
title<-"Faecalibacterium"
readRDS("data/ps_silva.rds")%>% 
  phyloseq::subset_samples(dog_name!="Charlotte") %>% 
  phyloseq::tax_glom(.,taxrank = "Genus",NArm = F) %>%
  # phyloseq::filter_taxa(., function (x) sum(x > 0) > 2, TRUE) %>%
  phyloseq::rarefy_even_depth(.) %>% 
  phyloseq::subset_samples(treatment=="w2") %>% 
  phyloseq::psmelt( ) %>% 
  dplyr::filter(Genus==title) %>% 
  ggstatsplot::ggwithinstats(data = .,x=time_point,y=Abundance,
                                       xlab=NULL,ylab=NULL,centrality.plotting=F,
                                       bf.message=F,title=title,
                                       method="non-parametric",palette="Dark2")

```

### Variable dry_wet

Comparativa (Wilcoxon) + análisis LDA de la abundancia de diferentes géneros bacterianos entre los grupos formados por las muestras de los perros con dieta dry(d) y wet(w)

*Deliverables: lefser_t1_vs_t0_w\_samples.pdf y boxplots independientes para cada género positivo al test*

Se observan taxas diferencialmente abundantes entre muestras del grupo de dieta seca (dry) y el grupo de muestras de dieta húmeda mediante *lefser*(<http://www.bioconductor.org/packages/release/bioc/html/lefser.html>).

-   Mayor abundancia en perros después de haber seguido dieta húmeda(w2): *Blautia, Dorea, Escherichia Shigella, grupo R.gnavus* y otros
-   Menor abundancia en perros después de haber seguido dieta húmeda(w2): *Megamonas, Prevotella, Erysipelatoclostrdium, Sutterella* y otros.

```{r DA vs time_point all dry_wet groups,eval=T, include=TRUE,echo=F, message=FALSE, warning=FALSE, paged.print=FALSE, tidy=F}

x.2.0 <-ps_silva %>% 
  phyloseq::subset_samples(dog_name!="Charlotte") %>% 
  phyloseq::tax_glom(.,taxrank = "Genus",NArm = F) %>%
  # phyloseq::filter_taxa(., function (x) sum(x > 0) > 2, TRUE) %>%
  phyloseq::rarefy_even_depth(.) %>% 
  phyloseq::subset_samples(dry_wet=="w")
  # microbiome::transform(transform="compositional")

se_ps<-SummarizedExperiment::SummarizedExperiment(assays = list(counts=as.matrix(otu_table(x.2.0))),
                                                  colData=sample_data(x.2.0),
                                                  rowData=tax_table(x.2.0))
aux_res<-lefser(expr=se_ps,groupCol="time_point",blockCol = NULL,lda.threshold = 1)
aux_res<-merge(aux_res,tax_table(x.2.0),by.x="Names",by.y="row.names")%>% 
  dplyr::select(Names,Phylum,Class,Order,Family,Genus,scores) %>% 
  dplyr::mutate(Class=ifelse(is.na(Class),Phylum,Class)) %>% 
  dplyr::mutate(Order=ifelse(is.na(Order),Class,Order)) %>% 
  dplyr::mutate(Family=ifelse(is.na(Family),Order,Family)) %>% 
  dplyr::mutate(Genus=ifelse(is.na(Genus),paste0(Family,"_spp"),Genus)) %>% 
  dplyr::filter(! is.na(Genus)) %>% 
  dplyr::mutate(otu=Names) %>% 
  dplyr::mutate(Names=Genus) %>% 
  dplyr::select(otu,Names,scores) %>% 
  dplyr::mutate(Names = forcats::fct_reorder(Names, scores)) %>% 
  dplyr::mutate(time_point=ifelse(scores>0,"t1","t0")) 

p0<- aux_res %>% 
    ggplot(.,aes(x=Names,y=scores,fill=time_point))+geom_bar(stat="identity")+coord_flip()+
    theme_classic()+ggtitle("t1 vs t0")+
    scale_fill_brewer(palette="Dark2")
ggsave(plot=p0,"output/Deliverables/lefser_t1_vs_t0_w_samples.pdf")

for(otu_name in aux_res$otu){
  my_ps <- x.2.0
  title <- aux_res %>% 
    dplyr::filter(otu==otu_name) 
    
  my_ps %>% 
  phyloseq::psmelt()%>% 
  dplyr::filter(OTU==otu_name) %>% 
  ggstatsplot::ggwithinstats(data = .,x=time_point,y=Abundance,
                                       xlab=NULL,ylab=NULL,centrality.plotting=F,
                                       bf.message=F,title=title$Names,
                                       method="non-parametric",palette="Dark2") %>% 
  
   ggsave(.,filename=paste0("output/boxplots/",title$Names,"_vs_time_point_wet_Samples.pdf"),width=7, height=7)
}

```

### Ordenación estratificada por grupos de *treatment*

Usaremos análisis de ordenación para visualizar los cambios en la estructura del microbioma, independientemente, en cada grupo definido por la variable principal *treatment*.

*Deliverables: Ordination_by_treatment_by_time_point.pdf*

Se puede observar un cambio consistente en todos los animales que forman el grupo *w2* en el espacio de ordenación, ligado a la proporción de variabilidad explicada en el análisis PERMANOVA anterior. De la misma manera, se puede observar que los cambios en los grupos de *treatment* restantes no son consistentes y no producen un *clustering* en el espacio de ordenación.

```{r ordination by treatment, include=TRUE,echo=F, message=FALSE, warning=FALSE, paged.print=FALSE, tidy=F}
suppressWarnings(require(phyloseq))
suppressWarnings(require(phylosmith))
suppressWarnings(require(patchwork))
suppressWarnings(require(vegan))
suppressWarnings(require(ggplot2))
suppressWarnings(require(ggforce))
x.2.0<-readRDS("data/ps_silva.rds")


#### treatment == "d"
set.seed(1234)
x.2.0.genus<-tax_glom(x.2.0,taxrank="Genus",NArm = F) %>% 
  microbiome::transform(.,transform="compositional") %>% 
  phyloseq::subset_samples(.,treatment=="d")

sampleData<-data.frame(sample_data(x.2.0.genus))
rownames(sampleData)<-sampleData$SampleID
sample_data(x.2.0.genus)<-sampleData
capture.output(myOrd<-ordinate(x.2.0.genus,method="NMDS",distance="wunifrac"),file = "/dev/null")

p.4.0.samples=plot_ordination(x.2.0.genus,myOrd)
p0<-p.4.0.samples  + geom_point(aes(color=time_point)) +ggtitle("NMDS(WUnifrac) by time_point / d samples")+
  theme(panel.border=element_blank(),panel.grid.major=element_blank(),panel.grid.minor=element_blank(),axis.line=element_line(colour="black"),axis.text.x=element_text(size=16),axis.text.y=element_text(size=16))+
  theme(axis.title.x=element_text(size=14),axis.title.y=element_text(size=14))+
  theme(legend.text=element_text(size=12,face="italic"),legend.title=element_text(size=12))+
  theme(plot.title=element_text(lineheight=1,face="bold",size=15))+stat_ellipse(alpha=1,mapping=aes(color=time_point))+
  theme_classic() + theme(axis.line.x = element_line(colour = "black", 
                                    size = 1, linetype = "solid"), axis.line.y = element_line(colour = "black", 
                                    size = 1, linetype = "solid"), axis.text.x = element_text(size = 10), 
                                    axis.text.y = element_text(size = 10),
                                    axis.title.x = element_text(size = 10, 
                                        face = "bold"), axis.title.y = element_text(size = 10, 
                                        face = "bold"), legend.title = element_text(size = 10, 
                                        face = "bold"), legend.text = element_text(size = 8), 
                                        legend.spacing.x = unit(0.005, "npc"), 
                                        legend.key.size = unit(4,"mm"), legend.background = element_rect(fill = (alpha = 0))) + 
        labs(x = "NMDS Dimension 1", y = "NMDS Dimension 2") + geom_line(aes(group=dog_name),color="grey")+
      theme(plot.title = element_text(size = 10, face = "bold"))+
        guides(fill = guide_legend(override.aes = list(size = 4)))


#### treatment == "w1"
set.seed(1234)
x.2.0.genus<-tax_glom(x.2.0,taxrank="Genus",NArm = F) %>% 
  microbiome::transform(.,transform="compositional") %>% 
  phyloseq::subset_samples(.,treatment=="w1")

sampleData<-data.frame(sample_data(x.2.0.genus))
rownames(sampleData)<-sampleData$SampleID
sample_data(x.2.0.genus)<-sampleData
capture.output(myOrd<-ordinate(x.2.0.genus,method="NMDS",distance="wunifrac"),file = "/dev/null")

p.4.0.samples=plot_ordination(x.2.0.genus,myOrd)
p1<-p.4.0.samples  + geom_point(aes(color=time_point)) +ggtitle("NMDS(WUnifrac) by time_point / w1 samples")+
  theme(panel.border=element_blank(),panel.grid.major=element_blank(),panel.grid.minor=element_blank(),axis.line=element_line(colour="black"),axis.text.x=element_text(8),axis.text.y=element_text(size=8))+
  theme(axis.title.x=element_text(size=14),axis.title.y=element_text(size=14))+
  theme(legend.text=element_text(size=12,face="italic"),legend.title=element_text(size=12))+
  theme(plot.title=element_text(lineheight=1,face="bold",size=15))+stat_ellipse(alpha=1,mapping=aes(color=time_point))+
  theme_classic() + theme(axis.line.x = element_line(colour = "black", 
                                    size = 1, linetype = "solid"), axis.line.y = element_line(colour = "black", 
                                    size = 1, linetype = "solid"), axis.text.x = element_text(size = 10), 
                                    axis.text.y = element_text(size = 10),
                                    axis.title.x = element_text(size = 10, 
                                        face = "bold"), axis.title.y = element_text(size = 10, 
                                        face = "bold"), legend.title = element_text(size = 10, 
                                        face = "bold"), legend.text = element_text(size = 8), 
                                        legend.spacing.x = unit(0.005, "npc"), 
                                        legend.key.size = unit(4,"mm"), legend.background = element_rect(fill = (alpha = 0))) + 
        labs(x = "NMDS Dimension 1", y = "NMDS Dimension 2") + geom_line(aes(group=dog_name),color="grey")+
        theme(plot.title = element_text(size = 10, face = "bold"))+
        guides(fill = guide_legend(override.aes = list(size = 4)))


#### treatment == "w2"
set.seed(1234)
x.2.0.genus<-tax_glom(x.2.0,taxrank="Genus",NArm = F) %>% 
  microbiome::transform(.,transform="compositional") %>% 
  phyloseq::subset_samples(.,treatment=="w2")

sampleData<-data.frame(sample_data(x.2.0.genus))
rownames(sampleData)<-sampleData$SampleID
sample_data(x.2.0.genus)<-sampleData
capture.output(myOrd<-ordinate(x.2.0.genus,method="NMDS",distance="wunifrac"),file = "/dev/null")

p.4.0.samples=plot_ordination(x.2.0.genus,myOrd)
p2<-p.4.0.samples  + geom_point(aes(color=time_point)) +ggtitle("NMDS(WUnifrac) by time_point / w2 samples")+
  theme(panel.border=element_blank(),panel.grid.major=element_blank(),panel.grid.minor=element_blank(),axis.line=element_line(colour="black"),axis.text.x=element_text(size=16),axis.text.y=element_text(size=16))+
  theme(axis.title.x=element_text(size=14),axis.title.y=element_text(size=14))+
  theme(legend.text=element_text(size=12,face="italic"),legend.title=element_text(size=12))+
  theme(plot.title=element_text(lineheight=1,face="bold",size=15))+stat_ellipse(alpha=1,mapping=aes(color=time_point))+
  theme_classic() + theme(axis.line.x = element_line(colour = "black", 
                                    size = 1, linetype = "solid"), axis.line.y = element_line(colour = "black", 
                                    size = 1, linetype = "solid"), axis.text.x = element_text(size = 10), 
                                    axis.text.y = element_text(size = 10),
                                    axis.title.x = element_text(size = 10, 
                                        face = "bold"), axis.title.y = element_text(size = 10, 
                                        face = "bold"), legend.title = element_text(size = 10, 
                                        face = "bold"), legend.text = element_text(size = 8), 
                                        legend.spacing.x = unit(0.005, "npc"), 
                                        legend.key.size = unit(4,"mm"), legend.background = element_rect(fill = (alpha = 0))) + 
        labs(x = "NMDS Dimension 1", y = "NMDS Dimension 2")+ geom_line(aes(group=dog_name),color="grey")+
        theme(plot.title = element_text(size = 10, face = "bold"))+
        guides(fill = guide_legend(override.aes = list(size = 4)))

#### time_point == "t1"
set.seed(1234)
x.2.0.genus<-tax_glom(x.2.0,taxrank="Genus",NArm = F) %>% 
  microbiome::transform(.,transform="compositional") %>% 
  phyloseq::subset_samples(.,time_point=="t1")

sampleData<-data.frame(sample_data(x.2.0.genus))
rownames(sampleData)<-sampleData$SampleID
sample_data(x.2.0.genus)<-sampleData
capture.output(myOrd<-ordinate(x.2.0.genus,method="NMDS",distance="wunifrac"),file = "/dev/null")

p.4.0.samples=plot_ordination(x.2.0.genus,myOrd)
p3<-p.4.0.samples  + geom_point(aes(color=treatment)) +ggtitle("NMDS(WUnifrac) by treatment (t1 samples)")+
  theme(panel.border=element_blank(),panel.grid.major=element_blank(),panel.grid.minor=element_blank(),axis.line=element_line(colour="black"),axis.text.x=element_text(size=16),axis.text.y=element_text(size=16))+
  theme(axis.title.x=element_text(size=14),axis.title.y=element_text(size=14))+
  theme(legend.text=element_text(size=12,face="italic"),legend.title=element_text(size=12))+
  theme(plot.title=element_text(lineheight=1,face="bold",size=15))+stat_ellipse(alpha=1,mapping=aes(color=treatment))+
  theme_classic() + theme(axis.line.x = element_line(colour = "black", 
                                    size = 1, linetype = "solid"), axis.line.y = element_line(colour = "black", 
                                    size = 1, linetype = "solid"), axis.text.x = element_text(size = 10), 
                                    axis.text.y = element_text(size = 10),
                                    axis.title.x = element_text(size = 10, 
                                        face = "bold"), axis.title.y = element_text(size = 10, 
                                        face = "bold"), legend.title = element_text(size = 10, 
                                        face = "bold"), legend.text = element_text(size = 8), 
                                        legend.spacing.x = unit(0.005, "npc"), 
                                        legend.key.size = unit(4,"mm"), legend.background = element_rect(fill = (alpha = 0)))+
        labs(x = "NMDS Dimension 1", y = "NMDS Dimension 2") +theme(plot.title = element_text(size = 10, face = "bold"))+
        guides(fill = guide_legend(override.aes = list(size = 4)))

pT <- (p0 | p1 ) / (p2  | p3)
pT
ggsave(pT,filename = "output/Deliverables/Ordination_by_treatment_by_time_point.pdf",width=15,height=15)
```
